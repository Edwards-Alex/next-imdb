## Next js Movie application



### 1. Create project 

- command create application 
- `npx create-next-app@latest`
- select the option you need



### 2. Start Home page 

- delete all at src/page.js replace it with react functional 



### 3. Add Header component and update the layout structure

- create folder components and file Header.jsx

- import Header.jsx in layout.js

- ```js
  import Header from "../components/Header.jsx";
  
  export default function RootLayout({ children }) {
    return (
      <html lang="en">
        <body
          className={`${geistSans.variable} ${geistMono.variable} antialiased`}
        >
          <Header />
          {children}
        </body>
      </html>
    );
  }
  ```

- write header navigation bar and application logo

- ```jsx
  export default function Header() {
    return (
      <div className='flex justify-between items-center p-3 max-w-6xl mx-auto'>
        <ul className='flex gap-4'>
          <li>
            <Link href={'/sign-in'}>Sign in</Link>
          </li>
          <li className='hidden sm:block'>
            <Link href={'/'}>Home</Link>
          </li>
          <li className='hidden sm:block'>
            <Link href={'/about'}>About</Link>
          </li>
        </ul>
        <Link href={'/'} className='flex gap-1 items-center'>
          <span className='text-2xl font-bold bg-amber-500 py-1 px-2 rounded-lg'>
            IMDB
          </span>
          <span className='text-xl hidden sm:inline'>Clone</span>
        </Link>
      </div>
    )
  }
  ```



### 4. Add dark mode functionality

- install next themes in order to easily add dark mode functionality

- https://www.npmjs.com/package/next-themes/v/0.0.6

- create components/ThemeCom.jsx  provider ThemeProvider and components/DarkModeSwitch.jsx

- ```jsx
  "use client"
  
  import { ThemeProvider } from 'next-themes'
  
  export default function Providers({ children }) {
      return (
          <ThemeProvider attribute='class' defaultTheme='system'>
              <div className="text-gray-700 dark:text-gray-200 dark:bg-gray-700 min-h-screen select-none
              transition-colors duration-300">
                  {children}
              </div>
          </ThemeProvider>)
  }
  ```

- ```jsx
  'use client'
  import { MdLightMode, MdDarkMode } from 'react-icons/md'
  import { useTheme } from "next-themes"
  import { useEffect, useState } from "react";
  
  export default function DarkModeSwitch() {
      const { theme, setTheme, systemTheme } = useTheme();
      const [mounted, setMounted] = useState(false);
      const currentTheme = theme === 'system' ? systemTheme : theme;
      useEffect(() => setMounted(true), []);
      return (
          <div>
              {mounted &&
                  (currentTheme === 'dark' ? (
                      <MdLightMode
                          onClick={() => setTheme('light')}
                          className='text-xl cursor-pointer hover:text-amber-500'
                      />
                  ) : (
                      <MdDarkMode
                          onClick={( ) => setTheme('dark')}
                          className='text-xl cursor-pointer hover:text-amber-500'
                      />
                  ))}
          </div>
      )
  }
  ```

- edit tailwind config add `darkMod:'class'` after`plugins:[],`

- add switch in Header 

- ```jsx
  import React from 'react'
  import Link from 'next/link'
  import DarkModeSwitch from './DarkModeSwitch.jsx'
  
  export default function Header() {
    return (
      <div className='flex justify-between items-center p-3 max-w-6xl mx-auto'>
        <ul className='flex gap-4'>
          <li>
            <Link href={'/sign-in'}>Sign in</Link>
          </li>
          <li className='hidden sm:block'>
            <Link href={'/'}>Home</Link>
          </li>
          <li className='hidden sm:block'>
            <Link href={'/about'}>About</Link>
          </li>
        </ul>
        <div className='flex items-center gap-4'>
          <DarkModeSwitch />
          <Link href={'/'} className='flex gap-1 items-center'>
            <span className='text-2xl font-bold bg-amber-500 py-1 px-2 rounded-lg'>
              IMDB
            </span>
            <span className='text-xl hidden sm:inline'>Clone</span>
          </Link>
        </div>
      </div>
    )
  }
  ```

- add `ThemeCOm` in layout.js and wrap the div

- ```js
  import { Geist, Geist_Mono } from "next/font/google";
  import "./globals.css";
  import Header from "@/components/Header";
  import ThemCom from "@/components/ThemeCom";
  
  const geistSans = Geist({
    variable: "--font-geist-sans",
    subsets: ["latin"],
  });
  
  const geistMono = Geist_Mono({
    variable: "--font-geist-mono",
    subsets: ["latin"],
  });
  
  export const metadata = {
    title: "Create Next App",
    description: "Generated by create next app",
  };
  
  export default function RootLayout({ children }) {
    return (
      <html lang="en" suppressHydrationWarning>
        <body>
          <ThemCom>
            <Header />
            {children}
          </ThemCom>
        </body>
      </html>
    );
  }
  ```



### 5. Integrate Clerk authentication with the app

- https://dashboard.clerk.com/  link for clerk authentication 
- install clerk package  `npm install @clerk/nextjs`
- follow the guide to set up sign-in and sign-up page for next-js 
- https://clerk.com/docs/references/nextjs/custom-sign-in-or-up-page?_gl=1

- use {SignedIn, SignedOut,UserButton} from '@clerk/next.js',let sign in icon change to user message

- ```jsx
  import React from 'react'
  import Link from 'next/link'
  import DarkModeSwitch from './DarkModeSwitch.jsx'
  import { SignedIn, SignedOut, SignInButton, UserButton } from '@clerk/nextjs'
  
  export default function Header() {
    return (
      <div className='flex justify-between items-center p-3 max-w-6xl mx-auto'>
        <ul className='flex gap-4'>
          <SignedIn>
            <UserButton />
          </SignedIn>
          <SignedOut>
            <Link href={'/sign-in'}>Sign in</Link>
          </SignedOut>
          <li className='hidden sm:block'>
            <Link href={'/'}>Home</Link>
          </li>
          <li className='hidden sm:block'>
            <Link href={'/about'}>About</Link>
          </li>
        </ul>
        <div className='flex items-center gap-4'>
          <DarkModeSwitch />
          <Link href={'/'} className='flex gap-1 items-center'>
            <span className='text-2xl font-bold bg-amber-500 py-1 px-2 rounded-lg'>
              IMDB
            </span>
            <span className='text-xl hidden sm:inline'>Clone</span>
          </Link>
        </div>
      </div>
    )
  }
  ```



### 6. Sync Clerk data to your app with webhooks

- use it's hook to send in the information to our server
- in order to use hooks we need to deploy our application to vercel first 
- then copy the url with deploy vercel and paste at create webhook in clerk dashboard





### 7. Add MongoDB to connect  Clerk and the database

- visit mongoDB url and create your database

- add your mongodb connect driver connect url at env.local 

- install mongondb and moongoose packages. 

- create src/lib/mongodb/moogoose.js create functionally connect our project to mongodb database. codes is below

- ```js
  import mongoose from "mongoose";
  
  let initialized = false;
  export const connect = async() => {
      mongoose.set('stricQuery',true);
      if(initialized){
          console.log('MongoDB already connected');
          return;
      }
      try{
          await mongoose.connect(process.env.MONGODB_URI,{
              dbName:'next-imdb-clerk',
              useNewUrlParser:true,
              useNewUnfiedTopology:true,
          });
          initialized=true,
          console.log('MongoDB connected');
      }catch(error){
          console.log('MongoDB connect error',error);
      }
  }
  ```

- create folder models and user.model.js  defined user schema

```js
import mongoose from "mongoose";

const favSchema = new mongoose.Schema({
  moveId: {
    type: String,
    required: true,
  },
  title: {
    type: String,
    required: true,
  },
  description: {
    type: String,
    required: true,
  },
  dateReleased: {
    type: Date,
    required: true,
  },
  rating: {
    type: Number,
    required: true,
  },
  image: {
    type: String,
    required: true,
  },
});

const userSchema = new mongoose.Schema(
  {
    clerkId: {
      type: String,
      required: true,
      unique: true,
    },
    email: {
      type: String,
      required: true,
      unique: true,
    },
    firstName: {
      type: String,
      required: true,
    },
    lastName: {
      type: String,
      required: true,
    },
    profilePicture: {
      type: String,
      required: true,
    },
    favs: {
      type: [favSchema],
      default: [],
    },
  },
  { timestamps: true }
);

const User = mongoose.models.User || mongoose.model("User", userSchema);
export default User;
```

- create actions folder store action such as delete user create user and update user

```js
import User from '../models/user.model.js';
import { connect } from '../mongdb/mongoose.js';

export const createOrUpdateUser = async (
    id,
    first_name,
    last_name,
    image_url,
    email_addresses
)=>{
    try {
        await connect();
        const user = await User.findOneAndUpdate(
            {clerkId: id},
            {
                $set: {
                    firstName: first_name,
                    lastName: last_name,
                    profilePicture: image_url,
                    email: email_addresses[0].email_address,
                },
            },
            {upsert: true, new: true}
        );
        return user;
    } catch (error) {
        console.log('Error: Could not create or update user:', error);
    }
};

export const  deleteUser = async (id) => {
    try {
        await connect();
        await User.findOneAndDelete({clerkId: id});
    } catch (error) {
        console.log('Error: Could not delete user:', error);
    }
};
```

- create route for user actions 

```js
import { Webhook } from "svix";
import { headers } from "next/headers";
import { createOrUpdateUser } from "../../../lib/actions/user";
import { clerkClient } from "@clerk/nextjs/server";

export async function POST(req) {
  const SIGNING_SECRET = process.env.SIGNING_SECRET;

  if (!SIGNING_SECRET) {
    throw new Error(
      "Error: Please add SIGNING_SECRET from Clerk Dashboard to .env or .env"
    );
  }

  // Create new Svix instance with secret
  const wh = new Webhook(SIGNING_SECRET);

  // Get headers
  const headerPayload = await headers();
  const svix_id = headerPayload.get("svix-id");
  const svix_timestamp = headerPayload.get("svix-timestamp");
  const svix_signature = headerPayload.get("svix-signature");

  // If there are no headers, error out
  if (!svix_id || !svix_timestamp || !svix_signature) {
    return new Response("Error: Missing Svix headers", {
      status: 400,
    });
  }

  // Get body
  const payload = await req.json();
  const body = JSON.stringify(payload);

  let evt;

  // Verify payload with headers
  try {
    evt = wh.verify(body, {
      "svix-id": svix_id,
      "svix-timestamp": svix_timestamp,
      "svix-signature": svix_signature,
    });
  } catch (err) {
    console.error("Error: Could not verify webhook:", err);
    return new Response("Error: Verification error", {
      status: 400,
    });
  }

  // Do something with payload
  // For this guide, log payload to console
  const { id } = evt.data;
  const eventType = evt.type;
  // console.log(`Received webhook with ID ${id} and event type of ${eventType}`)
  // console.log('Webhook payload:', body)

  if (eventType === "user.created" || eventType === "user.updated") {
    const { first_name, last_name, image_url, email_addresses } = evt?.date;
    try {
      const user = await createOrUpdateUser(
        id,
        first_name,
        last_name,
        image_url,
        email_addresses
      );

      if(user && eventType === 'user.created'){
        try {
          const client = await clerkClient();
          await client.users.updateUserMetadata(id, {
            publicMetadata: {
              userMongoId: user._id,
            },
          });
        } catch (error) {
          console.log('Error: Could not update user metadata:', error);
        }
      }
    } catch (error) {
      console.log('Error: Could not create or update user:', error);
      return new Response('Error: Could not create or update user',{
        status: 400,
      });
    }
  }

 /*  if (eventType === "user.updated") {
    console.log("User updated event");
  } */

  if (eventType === "user.deleted") {
    try {
      await deleteUser(id);
    } catch (error) {
      console.log('Error: Could not delete user:', error);
      return new Response('Error: Could not delete user',{
        status: 400,
      });
    }
  }

  return new Response("Webhook received", { status: 200 });
}
```







